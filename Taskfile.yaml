---
version: "3"

dotenv:
  - .env

tasks:
  run:
    desc: Deploy the external-dns-mikrotik webhook to the test cluster.
    cmds:
      - kubectl create ns external-dns || true
      - kubectl delete secret --namespace external-dns mikrotik-credentials || true
      - kubectl create secret generic --namespace external-dns --from-env-file=.env mikrotik-credentials || true
      - helm repo add external-dns https://kubernetes-sigs.github.io/external-dns && helm repo update
      - helm upgrade --install --namespace external-dns external-dns external-dns/external-dns -f deploy/values.yaml

  build:
    desc: Build the webhook binary.
    env:
      VERSION:
        sh: git describe --tags --always --dirty
      REVISION:
        sh: git rev-parse --short HEAD
    sources:
      - main.go
      - internal/*
      - go.mod
      - go.sum
    generates:
      - webhook
    cmd: go build  -ldflags "-s -w -X main.Version=${VERSION} -X main.Gitsha=${REVISION}" -o webhook

  test:
    desc: Run tests.
    cmd: go test -v ./... -race -covermode=atomic

  lint:
    desc: Run linter.
    cmd: golangci-lint run

  docker-build:
    desc: Build the docker image.
    cmd: docker build . -t external-dns-provider-mikrotik
